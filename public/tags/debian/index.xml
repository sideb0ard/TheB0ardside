<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Debian on The B0ardside </title>
    <link>http://theb0ardside.com/tags/debian/</link>
    <language>en-us</language>
    <author>Thorsten Sideb0ard</author>
    <rights>Copyleft (c) 1974 - The Future, Thorsten Sideb0ard; nae rights reserved.</rights>
    <updated>2012-04-03 00:00:00 &#43;0000 UTC</updated>
    
    <item>
      <title>Puppet stages and APT</title>
      <link>http://theb0ardside.com/puppetstagesandapt/</link>
      <pubDate>Tue, 03 Apr 2012 00:00:00 UTC</pubDate>
      <author>Thorsten Sideb0ard</author>
      <guid>http://theb0ardside.com/puppetstagesandapt/</guid>
      <description>&lt;p&gt;&lt;img src=&#34;http://www.stixrideshop.com/blog/wp-content/uploads/2012/03/gonz-3.bmp&#34; alt=&#34;gonz -- for no reason except he&amp;#039;s the MAN!&#34; /&gt;&lt;/p&gt;&lt;p&gt;At work, our old code deployment strategy was basically a wrapper script doing an svn checkout and some symlinking. With our move to Puppet for config management, we also moved to using Apt packaging for our code deployment, tying them together with a line similar to :&lt;/p&gt;&lt;p&gt;&lt;code&gt;class foo-export {&lt;br /&gt;    package { &amp;#039;foo-export&amp;#039;: ensure =&gt; latest }&lt;br /&gt;}&lt;/code&gt;&lt;/p&gt;&lt;p&gt;So that whenever we deploy a new version of a package to our apt-repo, it can then be installed with a:&lt;/p&gt;&lt;p&gt;&lt;code&gt;puppet agent --test&lt;/code&gt;&lt;br /&gt;(and with an initial dry-run using &lt;code&gt;--noop&lt;/code&gt;)&lt;/p&gt;&lt;p&gt;( I should mention I manage our Puppet runs via our own distributed scripts, rather than having the nodes set up to check in every 30mins - when I&#39;m doing so much work on our Puppet setup and config, I&#39;d rather not having machines check in automatically in case the config is in a broken state )&lt;/p&gt;&lt;p&gt;Inevitably I would run the above Puppet command and it would not find any new packages, because &amp;#8216;d&#39;uh!&#39;, of course I still need to run an &lt;code&gt;apt-get update&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;I&#39;ve been using Puppet stages for a while now, in order to group package installations in a broader sense rather than manually spelling out every dependency with a &lt;code&gt;require =&gt;&lt;/code&gt; stanza, so it was a simple addition to add in a &lt;code&gt;pre&lt;/code&gt; stage, and have the nodes run &lt;code&gt;apt-get update&lt;/code&gt; before any runs.&lt;/p&gt;&lt;p&gt;In order to use stages, you need to first define them in your site.pp. By default every defined class runs under Stage[main], so you just need to add the new stages and define the running order. (full Puppet stage documentation is &lt;a href=&#34;http://docs.puppetlabs.com/guides/language_guide.html&#34; title=&#34;Puppet Stages&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;)&lt;/p&gt;&lt;p&gt;At the top of my site.pp file, I added a pre and post stage, then define the execution order via:&lt;/p&gt;&lt;p&gt;&lt;code&gt;stage { [pre, post]: }&lt;br /&gt;Stage[pre] -&gt; Stage[main] -&gt; Stage[post]&lt;/code&gt;&lt;/p&gt;&lt;p&gt;Then I created a class called apt-hupdate (sorry, i use stupid naming conventions!) in&lt;br /&gt;&lt;code&gt;modules/apt-hupdate/manifests/init.pp&lt;/code&gt;&lt;/p&gt;&lt;p&gt;which contained:&lt;br /&gt;&lt;code&gt;class apt-hupdate {&lt;/p&gt;&lt;p&gt;    exec { &#34;aptHupdate&#34;:&lt;br /&gt;        command =&gt; &#34;/usr/bin/apt-get update&#34;,&lt;br /&gt;    }&lt;br /&gt;}&lt;/code&gt;&lt;/p&gt;&lt;p&gt;And finally, include that in your site.pp with:&lt;/p&gt;&lt;p&gt;&lt;code&gt;class { apt-hupdate: stage =&gt; pre }&lt;/code&gt;&lt;/p&gt;&lt;p&gt;Now every time you do a Puppet run, &lt;code&gt;apt-get update&lt;/code&gt; will be the first task run.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>building a DEB package from a perl script</title>
      <link>http://theb0ardside.com/buildingadebpackagefromaperlscript/</link>
      <pubDate>Thu, 16 Feb 2012 00:00:00 UTC</pubDate>
      <author>Thorsten Sideb0ard</author>
      <guid>http://theb0ardside.com/buildingadebpackagefromaperlscript/</guid>
      <description>&lt;p&gt;I have a speedtest perl script i wrote - nothing complicated, takes a file and uploads it to a remote FTP or SFTP server, while calculating how long, then gives you a a measure of the MB/per second bandwidth between two sites.&lt;/p&gt;&lt;p&gt;I want it available on a selection of machines so it can run from wherever, so I thought i&#39;d package it up as a .DEB file and stick it in our local repo. Nothing complicated in that, and there are a &lt;a href=&#34;http://www.debian-administration.org/articles/336&#34; target=&#34;_blank&#34;&gt;number&lt;/a&gt; of &lt;a href=&#34;http://www.debian-administration.org/articles/337&#34; target=&#34;_blank&#34;&gt;online&lt;/a&gt; &lt;a href=&#34;http://www.debian.org/doc/manuals/debian-faq/ch-pkg_basics.en.html&#34; target=&#34;_blank&#34;&gt;tutorials&lt;/a&gt; about building your own debs. The main drawback with most I found was that they assume you are actually building from source rather than just distributing a script, although I also found &lt;a href=&#34;http://askubuntu.com/questions/27715/create-a-deb-package-from-scripts-or-binaries&#34; target=&#34;_blank&#34;&gt;a relevant Ubuntu thread&lt;/a&gt; which is pretty simple and to the point.&lt;/p&gt;&lt;p&gt;However, even using these tutorials it still took me a few hours to figure out. There are just a couple of non-obvious points, so i figure writing out my own steps is worth recording -&lt;/p&gt;&lt;p&gt;So first, grab your required packages:&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;apt-get install dh-make dpkg-dev debhelper devscripts fakeroot lintian&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;You will need to build from a directory with the name of your script in the form &lt;code&gt;packagename-version&lt;/code&gt;, so for mine i created &lt;strong&gt;/tmp/speedtest-1.0&lt;/strong&gt;, then copied in my script &amp;#8216;&lt;strong&gt;speedtest&lt;/strong&gt;&amp;#8216; and it&#39;s data file &lt;strong&gt;25MBFLAC.file&lt;/strong&gt; ( which i could have created with &lt;strong&gt;dd&lt;/strong&gt; on the box rather than copy over, but downloading the file is actually quicker in this situation ).&lt;/p&gt;&lt;p&gt;The first step is to run:&lt;/p&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;dh_make -s --indep --createorig -e thor@valhalla.com&lt;/code&gt;&lt;/strong&gt;&lt;br /&gt;(dash-s means create a single binary .deb - i.e. no source version; indep means architecture-independent; and createorig is to indicate you are the original maintainer)&lt;/p&gt;&lt;p&gt;this creates a top-level &amp;#8216;&lt;strong&gt;debian&lt;/strong&gt;&amp;#8216; directory containing all the necessary config files.&lt;br /&gt;The main one you need to edit is &lt;strong&gt;debian/control&lt;/strong&gt; - you prob only need fill in &amp;#8220;section&amp;#8221;, &amp;#8220;homepage&amp;#8221; and &amp;#8220;Description&amp;#8221;&lt;/p&gt;&lt;p&gt;Mine looks like:&lt;/p&gt;&lt;p&gt;&lt;code&gt;Source: speedtest&lt;br /&gt;Section: web&lt;br /&gt;Priority: extra&lt;br /&gt;Maintainer: Thorsten Sideboard &amp;lt;thor@valhalla.com&amp;gt;&lt;br /&gt;Build-Depends: debhelper (&gt;= 7.0.50~)&lt;br /&gt;Standards-Version: 3.8.4&lt;br /&gt;Homepage: http://github.com/sideboard/speedtest.git&lt;/p&gt;&lt;p&gt;Package: speedtest&lt;br /&gt;Architecture: all&lt;br /&gt;Depends: ${misc:Depends}&lt;br /&gt;Description: Test Upload Speeds&lt;br /&gt;&lt;/code&gt;&lt;/p&gt;&lt;p&gt;One of the things which baffled me for a while, which was answered in the &lt;a href=&#34;http://askubuntu.com/questions/27715/create-a-deb-package-from-scripts-or-binaries&#34; target=&#34;_blank&#34;&gt;askubuntu link above&lt;/a&gt;, was how to specify where something is installed &amp;#8212; it goes in a file &amp;#8216;&lt;strong&gt;debian/install&lt;/strong&gt;&amp;#8216; which isn&#39;t created for you. The format of the file is &amp;#8216;&lt;strong&gt;filename location/to/be/installed&lt;/strong&gt;&amp;#8221; (without the initial slash)&lt;/p&gt;&lt;p&gt;so in my case, i ran:&lt;br /&gt;&lt;code&gt;echo &#34;speedtest usr/local/Scriptz/&#34; &gt; debian/install&lt;br /&gt;echo &#34;25MBFLAC.file usr/local/Scriptz/&#34; &gt;&gt; debian/install&lt;br /&gt;&lt;/code&gt;&lt;/p&gt;&lt;p&gt;At this point, you should then be able to run:&lt;br /&gt;&lt;code&gt;debuild -us -uc&lt;/code&gt;&lt;/p&gt;&lt;p&gt;and you &lt;em&gt;should&lt;/em&gt; have a deb file built. but..&lt;/p&gt;&lt;p&gt;First i ran into :&lt;/p&gt;&lt;p&gt;&lt;code&gt;dpkg-source: error: can&amp;#039;t build with source format &amp;#039;3.0 (quilt)&amp;#039;: no orig.tar file found&lt;/code&gt;&lt;/p&gt;&lt;p&gt;As the above-mentioned askubuntu post says, you can &lt;/p&gt;&lt;p&gt;&lt;code&gt;echo &#34;1.0&#34; &gt; debian/source/format&lt;/code&gt;&lt;/p&gt;&lt;p&gt;then re-running the &lt;code&gt;debuild -us -uc&lt;/code&gt; i ran into &lt;/p&gt;&lt;p&gt;&lt;code&gt;dpkg-source: error: cannot represent change to speedtemp-1.0/25MBFLAC.file: binary file contents changed&lt;/code&gt;&lt;/p&gt;&lt;p&gt;This error is due to leftover build-cruft from my last run - if you check the directory one step up from where you are, you&#39;ll see debuild has already built some files for you, typically a tar.gz, a .dsc and a .build file. Delete all them, then re-run &lt;code&gt;debuild -us -uc&lt;/code&gt; &amp;#8212; now it should build properly!&lt;/p&gt;&lt;p&gt;ah! &lt;/p&gt;&lt;p&gt;&lt;code&gt;dh_usrlocal: debian/speedtemp/usr/local/Scriptz/speedtest is not a directory&lt;/code&gt;&lt;/p&gt;&lt;p&gt;This one also caught me out for a while - turns out this is caused by my specifying &amp;#8220;/usr/local/Scriptz&amp;#8221; as my install location - &lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;Most third-party software installs itself in the /usr/local directory hierarchy. On Debian this is reserved for private use by the system administrator, so packages must not use directories such as /usr/local/bin but should instead use system directories such as /usr/bin, obeying the Filesystem Hierarchy Standard (FHS).&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt; (from &lt;a href=&#34;http://www.debian.org/doc/manuals/maint-guide/modify.en.html#destdir&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;)&lt;/p&gt;&lt;p&gt;So, yeah, i changed my &lt;strong&gt;debian/install&lt;/strong&gt; file to be &amp;#8220;&lt;strong&gt;speedtest usr/bin&lt;/strong&gt;&amp;#8221;&lt;/p&gt;&lt;p&gt;and finally! running &lt;code&gt;debuild -us -uc&lt;/code&gt; completes properly, outputting a &lt;strong&gt;/tmp/speedtest_1.0-1_all.deb&lt;/strong&gt; which can then be installed via&lt;br /&gt;&lt;strong&gt;&lt;code&gt;dpkg -i /tmp/speedtest_1.0-1_all.deb &lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;One last note &amp;#8212; there are four useful scripts to also know about &amp;#8212; &lt;strong&gt;&lt;code&gt;preinst, postinst, prerm, postrm&lt;/code&gt;&lt;/strong&gt; &amp;#8212; these should be in the &lt;code&gt;debian/&lt;/code&gt; directory - pretty self-explanatory - pre- and post- install and remove scripts - if these exist, they will be run exactly as they are named, so for example, i wanted my 25MBFLAC.file still to be installed under /usr/local/Scriptz, so i listed it to be installed in the debian/install file as &amp;#8220;25MBFLAC.file tmp&amp;#8221; and then in my postinst file, i added:&lt;/p&gt;&lt;p&gt;&lt;code&gt;#!/bin/sh&lt;br /&gt;mv /tmp/25MBFLAC.file /usr/local/Scriptz/&lt;br /&gt;&lt;/code&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
