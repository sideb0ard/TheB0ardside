<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>
    <meta charset="utf-8">

    <base href="http://theb0ardside.com/">
    <title> TheB0ardside.com </title>
    <link rel="canonical" href="http://theb0ardside.com/getoffofmycloud/">
    <link href="http://theb0ardside.com/static/css/b0ardstrap.min.css" rel="stylesheet"/>
    <link href="http://theb0ardside.com/static/css/b0ardstyle.css" rel="stylesheet"/>

</head>
<body lang="en">
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  
  <div class="navbar-header">
    <a class="navbar-brand" href="http://theb0ardside.com/">The B0ardside</a>
  </div>

  <div>
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">hello<b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><img src="http://theb0ardside.com/static/img/thor.jpg"></li>
            <li><a target="new" href="mailto:thorsten@theb0ardside.com?subject=hullo">Email</a></li>
            <li><a target="new" href="http://twitter.com/sideb0ard">Twitter</a></li>
            <li><a target="new" href="http://github.com/sideb0ard">Github</a></li>
            <li><a target="new" href="http://drawingb0ard.blogspot.com/">Drawings</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

  <div class="container">
  <div id="page">



<section id="main">
  <h1 id="title">Get Off Of My Cloud!</h1>
  <div>
        <article id="content">
           <p>I work around Hadoop a lot at work, however my duties don't really require me to interact much beyond the occasional data-mining work in Hive. Recently, I was intrigued to read that Amazon's EC2 services are built upon Xen Hypervisor, which is also something I use, but don't administer. I figured I would combine them into learning exercise by setting up a Xen server, create a little virtual cluster, configure them all via Puppet (another project i've been wanting a look at) and finally setup Hadoop on them all. Here's what happened..</p><p><img class="aligncenter" title="jagger" src="http://farm6.static.flickr.com/5081/5283868550_e7f27ff59e_z.jpg" alt="" width="458" height="640" /></p><p><strong>XEN INSTALL&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</strong></p><p>So  - Xen is virtualisation software - the master host where the Hypervisor software is installed is called Dom0, and it can have many DomU guests, each a virtual machine which can run a host Operating System. In order to install the Xen Hypervisor and run Dom0, the kernel needs some modifications, and my first surprise was to discover recent releases of Ubuntu's kernel don't have Dom0 support. (The most recent discussion I could find on this was <a title="thread" href="http://ubuntuforums.org/showthread.php?t=990180&amp;page=2" target="_blank">here</a>, from 2010, so things may have changed)</p><p>My Ubuntu install has been through several years of upgrading and was getting a little crufty, plus the recent move to Unity desktop with Natty 11.04 wasn't exciting me very much. I've also been keen to give Debian another go, as it's been a few years, so rather than backport a Debian kernel to Ubuntu, I just went for a fresh install of Debian 6.0/Squeeze.</p><p>Aside from kernel support, more recent hardware support seems, if not essential, to make installation a lot easier. You need some BIOS support and CPU support - I'm running on a DELL Precision 390 - BIOS v.2.1.2 and CPU is a Pentium Core-2 Duo. I switched on Virtualization under the Performance section of my BIOS.</p><p>Aiight, so following instructions at <a href="http://wiki.debian.org/Xen" target="_blank">http://wiki.debian.org/Xen</a> i installed kernel and meta package..</p><p><strong>apt-get install xen-linux-system</strong></p><p>Then to ensure the xen kernel is loaded first, you have to move some files around:<br /><strong>cd /etc/grub.d/</strong><span style="color: #000000;"><strong><br /></strong></span> <strong> mv 10_linux 50_linux</strong><br /><strong> update-grub</strong></p><p>Reboot machine and you should be running with a Dom0 kernel:</p><p><strong>root@bitbot:/etc/puppet# uname -a</strong><br /><strong> Linux bitbot 2.6.32-5-xen-amd64 #1 SMP Thu May 5 00:57:12 UTC 2011 x86_64 GNU/Linux</strong></p><p>Now install Xen tools..</p><p><strong>apt-get install xen-tools</strong></p><p>Following some older HOWTO's i started building my own filesystems for my first Guest machine:</p><p><strong>dd if=/dev/zero of=/Xen/host/weebit1/root.img bs=1024k count=1024mkfs -t ext3 /Xen/hosts/weebit1/root.img</strong><br /><strong>dd if=/dev/zero of=/Xen/host/weebit1/swap bs=1024k count=1024</strong></p><p>However -  <strong>DON'T!</strong> there's no need - Have a read through of the instructions here -</p><p><strong>xen-create-image -manual</strong></p><p>(basically it does everything for you - i.e. creating partitions &amp; swap, formatting, filesystems, xen config file, installing OS)</p><p>Then all you need to type is:<br /><strong>xen-create-image -hostname weebit -vcpus 2 -scsi -dist squeeze-pygrub -dir=/Xen/host</strong></p><p>(i had tried installing natty first, but was having trouble booting the VM - ran into issues with &#8220;<strong>ALERT!  /dev/sda2 does not exist.  Dropping to a shell!</strong>&#8220;)</p><p>With Debian systems, the Xen install doesn't enable the Ethernet bridging by default so you need to edit <strong>/etc/xen/xend-config.sxp </strong>and uncomment:</p><p><strong><strong>(network-script network-bridge)</strong><br /></strong></p><p><strong> </strong>(Or when you try to start up your VM later you will run into:<br />&#8220;<strong>xm create /etc/xen/weebit.cfg -cError: Device 0 (vif) could not be connected. Could not find bridge, and none was specified</strong>&#8220;)</p><p>Restart Xend<br /><strong>/etc/init.d/xend restart</strong></p><p>Once you have your Xen hosts created succesfully, you can start them with a command like:<br /><strong>xm create /etc/xen/weebit.cfg -c </strong>(where the cfg file matches the name of the host you created)</p><p>I created two VM's - weebit and weebot - (and my master host is called bitbot) - yes, it gets confusing!</p><p><strong>PUPPET SETUP..&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;</strong></p><p>Okay, two VMs setup with networking, so next thing was setting up Puppet on them - this part was by far the most troublesome - although there is nothing particularly complex about Puppet, it's error messages aren't the most verbose or helpful, and I found it quite sensitive to permissions and other peculiarities.</p><p>Here's the main docs:<br /><a href="http://docs.puppetlabs.com/guides/configuring.html" target="_blank"> http://docs.puppetlabs.com/guides/configuring.html</a></p><p>This part is not essential (you can override it in configuration), however a default Puppet install expects the server to be called <strong>puppet </strong>so it's best to setup some name resolution -I set it up simply via <strong>/etc/hosts</strong>.</p><p><strong>PUPPET SERVER setup:</strong></p><p><strong>apt-get install puppet puppetmaster</strong><br /><strong> update-rc.d puppetmaster defaults</strong></p><p>Just to test it locally, run a puppet agent on the server:</p><p><strong>puppet agent -test</strong></p><p>All looks good, apart from it doesn't do anything yet. My first test and following with many of the HOWTOs out there was to fix sudoers perms</p><p><strong>vi manifests/site.pp</strong></p><p><strong># fixup permissions on sudo</strong><br /><strong> class sudo {</strong><br /><strong> file { &#8220;/etc/sudoers&#8221;:</strong><br /><strong> owner =&gt; root,</strong><br /><strong> group =&gt; root,</strong><br /><strong> mode =&gt; 440,</strong><br /><strong> }</strong><br /><strong> }</strong></p><p><strong>node default {</strong><br /><strong> include sudo</strong><br /><strong> }</strong></p><p>In order to give it something to fix, i changed the ownership to my own user and altered the perm:<br /><strong>chown thorsten /etc/sudoers</strong><br /><strong> chmod 400 /etc/sudoers</strong></p><p>Ran this again:<br /><strong>puppet agent -test</strong></p><p>Nothing! huh. however, running:<br /><strong>puppet apply /etc/puppet/manifests/site.pp</strong></p><p>That worked fine. So first lesson - after any config changes - you need to restart Puppet -<br /><strong>/etc/init.d/puppermaster restart</strong></p><p><strong><strong>puppet agent -test</strong></strong><br /><strong>notice: /Stage[main]/Sudo/File[/etc/sudoers]/owner: owner changed &#8216;thorsten' to &#8216;root'</strong></p><p>Boom! all good.</p><p>Now, rather than have a monolithic site manifest, Puppet best practises advocates a modular approach.</p><p><em><strong>&#8220;Each module has a specific directory structure that allows Puppet to find all elements of the module and auto-load them.&#8221;</strong></em></p><p><strong>mkdir -p /etc/puppet/modules/sudo/manifests</strong></p><p>move the &#8216;sudo' class logic from site.pp to modules/sudo/manifests/init.pp:</p><p><strong>vi modules/sudo/manifests/init.pp</strong></p><p><strong># /etc/puppet/modules/sudo/manifests/init.pp</strong><br /><strong> class sudo {</strong><br /><strong> package { sudo: ensure =&gt; latest }</strong><br /><strong> file { &#8220;/etc/sudoers&#8221;:</strong><br /><strong> owner   =&gt; root,</strong><br /><strong> group   =&gt; root,</strong><br /><strong> mode    =&gt; 440,</strong><br /><strong> source  =&gt; &#8220;puppet:///sudo/sudoers&#8221;,</strong><br /><strong> require =&gt; Package["sudo"],</strong><br /><strong> }</strong><br /><strong> }</strong></p><p><strong>mkdir /etc/puppet/modules/sudo/files</strong><br /><strong> cp /etc/sudoers /etc/puppet/modules/sudo/files</strong></p><p>Modules in the modulepath should be auto loaded, however we can explicitly import them too:</p><p><strong># /etc/puppet/manifests/modules.pp</strong><br /><strong> import &#8220;sudo&#8221;</strong></p><p>Move the Node list into manifests/nodes.pp</p><p><strong>node default {</strong><br /><strong> include sudo</strong><br /><strong> }</strong></p><p>Finally, update site.pp to remove previous statements, and have it import the new modules and nodes .pp files:</p><p><strong># /etc/puppet/manifests/site.pp</strong><br /><strong> import &#8220;modules&#8221;</strong><br /><strong> import &#8220;nodes&#8221;</strong></p><p>Again, restart Puppetmaster, then test the agent:</p><p><strong>puppet agent -test</strong><br /><strong> err: /Stage[main]/Sudo/File[/etc/sudoers]: Could not evaluate: Error 400 on SERVER: Permission denied - /etc/puppet/modules/sudo/files/sudoers Could not retrieve file metadata for puppet:///sudo/sudoers: Error 400 on SERVER: Permission denied - /etc/puppet/modules/sudo/files/sudoers at /etc/puppet/modules/sudo/manifests/init.pp:13</strong></p><p>Second lesson! Make sure the modules dir is owned by your Puppet user account:</p><p><strong>chown -R puppet modules</strong></p><p><strong><strong>puppet agent -test</strong><br /></strong></p><p>Cool, all good again!</p><p><strong>PUPPET CLIENT INSTALL&#8212;&#8212;&#8212;-</strong></p><p><strong>apt-get install puppet</strong><br />In order to have it start at boot:</p><p><strong>vi /etc/default/puppet</strong></p><p>Test it..<br /><strong>puppet agent -server puppet -waitforcert 60 -test</strong></p><p>You should see:<br />i<strong>nfo: Requesting certificate</strong><br /><strong> warning: peer certificate won't be verified in this SSL session</strong><br /><strong> notice: Did not receive certificate</strong></p><p>This is the inbuilt security, whereby the server needs to approve and sign the client certificates before they can be administered.</p><p>Back on the server type:<br /><strong>puppet cert -list</strong></p><p>You should see your client machine listed. To approve it set:<br /><strong>puppet cert -sign  weebot</strong></p><p>BANG!</p><p>Now on your client, you can run:<br /><strong>puppet agent -test</strong><br />(the -test option adds verbose and no-daemonize to the runtime so you can see whats going on)</p><p>You should hopefully see it now install the sudo package on your clients.</p><p>I wanted to test adding another package beyond the SUDO setup, so went ahead with NTP</p><p><strong>cd /etc/puppet/modules/</strong></p><p><strong>mkdir -p ntp/manifests </strong> &lt;- WATCH OUT, I ORIGINALLY NAMED THIS &#8216;MANIFEST' - SINGULAR - AND IT TOOK ME AGES TO FIND OUT WHY IT WASN'T WORKING</p><p><strong>vi ntp/manifests/init.pp</strong><br /><strong> # /etc/puppet/modules/ntp/manifests/init.pp</strong><br /><strong> class ntp {</strong><br /><strong> package { &#8220;ntp&#8221;:</strong><br /><strong> ensure =&gt; installed</strong><br /><strong> }</strong></p><p><strong> service { &#8220;ntp&#8221;:</strong><br /><strong> ensure =&gt; running,</strong><br /><strong> }</strong><br /><strong> }</strong></p><p>Added ntp to manifests/modules with:<br /><strong>import &#8220;ntp&#8221;</strong></p><p>updated manifests/nodes.pp with:<br /><strong>include ntp</strong></p><p>And again -<br /><strong>chown -R puppet modules</strong><br /><strong> /etc/init.d/puppermaster restart</strong></p><p>On the clients:</p><p><strong>puppet agent -test</strong></p><p>So just to summarize - watch your permissions, watch yer typos and remember to restart!</p><p>For troubleshooting, puppetmaster logs to <strong>/var/log.syslog</strong> by default</p><p>I searched around for a while to find out whether I would need to set up cron jobs to automate the client, but no, if you set /etc/default/puppet to start at boot, as mentioned above, it will launch and daemonize itself. Default is to run every 30mins. To find out all the default options, run <strong>puppet agent -genconfig</strong></p><p><strong>HADOOP SETUP&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</strong></p><p>Okay, we have one master node, and two VM's running, all configured with Puppet. Now to setup Hadoop on them.</p><p>There are no Hadoop packages in the standard Debian repositories, so you have to add <a href="http://www.cloudera.com/">Cloudera's </a>manually. They don't have specific packages for Squeeze yet, but the Lenny ones work fine.</p><p>Add the following to your <strong>/etc/apt/sources.list</strong> on the Master:<br /><strong>#HADOOP</strong><br /><strong> deb http://archive.cloudera.com/debian lenny-cdh3b3 contrib</strong><br /><strong> deb-src http://archive.cloudera.com/debian lenny-cdh3b3 contrib</strong></p><p>Then add their public key to your apt keyring:<br /><strong>curl -s http://archive.cloudera.com/debian/archive.key | sudo apt-key add -</strong></p><p><strong>apt-get update</strong><br />and<br /><strong>apt-get install hadoop-0.20</strong><br />to ensure that all works fine on the server.</p><p>All good?<br />aiiiight..</p><p>Okay, so we've been using Puppet to configure the VMs, so let's also add apt.sources to our Puppet configuration:</p><p><strong>cd /etc/puppet</strong><br /><strong>mkdir -p modules/apt/manifests</strong><br /><strong> mkdir -p modules/apt/files</strong><br /><strong> cp /etc/apt/sources.list modules/apt/files/</strong></p><p>Create:<br /><strong># /etc/puppet/modules/apt/manifests/init.pp</strong></p><p><strong>class apt {</strong></p><p><strong> file { &#8220;/etc/apt/sources.list&#8221;:</strong><br /><strong> owner   =&gt; root,</strong><br /><strong> group   =&gt; root,</strong><br /><strong> mode    =&gt; 644,</strong><br /><strong> source  =&gt; &#8220;puppet:///apt/sources.list&#8221;,</strong><br /><strong> }</strong></p><p><strong> exec { subscribe-echo:</strong><br /><strong> command     =&gt; &#8220;/usr/bin/apt-get -q -q update&#8221;,</strong><br /><strong> logoutput   =&gt; false,</strong><br /><strong> refreshonly =&gt; true,</strong><br /><strong> subscribe   =&gt; file["/etc/apt/sources.list"]</strong><br /><strong> }</strong><br /><strong> }</strong></p><p><strong>chown -R puppet modules/</strong></p><p>Add the new entries to:<br /><strong>vi manifests/modules.pp</strong><br /><strong> import &#8220;apt&#8221;</strong><br /><strong> vi manifests/nodes.pp</strong><br /><strong> include apt</strong><br /><strong> /etc/init.d/puppetmaster restart</strong></p><p>At this point, I manually added the cloudera public key to both VMs (same command as above) - probably a smarter way of doing this, but this sufficed for my own efforts:<br />&#8220;<strong>curl -s http://archive.cloudera.com/debian/archive.key | sudo apt-key add -</strong>&#8221;</p><p>Again, run the:<br /><strong>puppet client -test</strong><br />and if the planets are in alignment, your updated <strong>sources.list</strong> file should be copied over to the clients, and an <strong>apt-get update</strong> will be run.</p><p>Ok, so hopefully just one last step for Hadoop installation. Lets now add a Hadoop class to Puppet:</p><p><strong>mkdir -p /etc/puppet/modules/hadoop/manifests</strong><br /><strong> vi /etc/puppet/modules/hadoop/manifests/init.pp</strong></p><p><strong># /etc/puppet/modules/hadoop/manifests/init.pp</strong></p><p><strong>class hadoop {</strong></p><p><strong> package { &#8220;hadoop-0.20&#8243;:</strong><br /><strong> ensure =&gt; installed</strong><br /><strong> }</strong><br /><strong>}</strong></p><p>The now familiar dance..<br /><strong>vi manifests/modules.pp</strong><br /><strong> add import &#8220;hadoop&#8221;</strong></p><p><strong>vi manifests/nodes.pp</strong><br /><strong> add   include hadoop</strong></p><p><strong>chown -R puppet modules/</strong><br /><strong> /etc/init.d/puppetmaster restart</strong></p><p>Moment of truth.. Go to the clients and run our:<br /><strong>puppet agent -test</strong></p><p><strong>The following packages have unmet dependencies:</strong><br /><strong> hadoop-0.20 : Depends: sun-java6-jre but it is not going to be installed</strong><br /><strong> Depends: sun-java6-bin but it is not going to be installed</strong></p><p>Bugger! You have to accept a user license to use Sun's (well Oracle now) version of Java, so I had to run &#8216;<strong>apt-get -f install</strong>&#8216; by hand so i could accept Yes on the license. I'm not sure if there is an automated way of doing this or if it is necessary. Again, for my purposes it was fine to just do by hand. If you have a much bigger installation you might want to work out a workaround for this. ( I had already installed Java on my master/physical machine)</p><p>So - an almost automated install of Hadoop on a three node cluster! I haven't configured my cluster with anything useful yet, so I'll leave that for another article..</p><p>thor</p><p>#############</p><p>The following resources all proved useful :<br /><a href="http://docs.puppetlabs.com/references/latest/configuration.html">http://docs.puppetlabs.com/references/latest/configuration.html</a><br /><a href="http://docs.puppetlabs.com/guides/tools.html">http://docs.puppetlabs.com/guides/tools.html</a><br /><a href="http://docs.puppetlabs.com/man/agent.html">http://docs.puppetlabs.com/man/agent.html</a><br /><a href="http://bitfieldconsulting.com/puppet-tutorial">http://bitfieldconsulting.com/puppet-tutorial</a><br /><a href="http://www.debian-administration.org/articles/526">http://www.debian-administration.org/articles/526</a><br /><a href="http://projects.puppetlabs.com/projects/puppet/wiki/Simplest_Puppet_Install_Pattern">http://projects.puppetlabs.com/projects/puppet/wiki/Simplest_Puppet_Install_Pattern</a><br /><a href="http://bitcube.co.uk/content/puppet-errors-explained">http://bitcube.co.uk/content/puppet-errors-explained</a><br /><a href="http://groups.google.com/group/puppet-users/browse_thread/thread/66361418d801a97c">http://groups.google.com/group/puppet-users/browse_thread/thread/66361418d801a97c</a></p>

        </article>
  </div>
</section>

<aside id="meta">
    <div>
    <section>
      <h4 id="date"> Fri May 27, 2011 </h4>
    </section>
    <ul id="tags">
      
        <li> <a href="http://theb0ardside.com//tags/abstraction">abstraction</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/cloud">cloud</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/configuration-management">configuration management</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/future">future</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/hadoop">hadoop</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/hardware">hardware</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/puppet">puppet</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/simulator">simulator</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/unix">unix</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/virtualization">virtualization</a> </li>
      
        <li> <a href="http://theb0ardside.com//tags/xen">xen</a> </li>
      
    </ul>
    </div>
    <div>
        
          <a class="previous" href="http://theb0ardside.com/80shairunixz/">Previous:: 80s hair unixz</a>
        
    </div>
    <div>
        
          <a class="next" href="http://theb0ardside.com/recordstorebot/">Next:: Record Store Bot</a>
        
    </div>
</aside>

      <script src="http://theb0ardside.com/static/js/jquery.js"></script>
      <script src="http://theb0ardside.com/static/js/bootstrap.min.js"></script>
      </div>
      </div>
      <div id="footer"></div>
  </body>

</html>

